name: Build APK

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download APK from APKMirror
        run: |
          set -e
          URL="https://www.apkmirror.com/wp-content/themes/APKMirror/download.php?id=825476&key=20424ec637e167ac163dfe24ad124f799f2023b0"
          curl -L -A "Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0 Safari/537.36" \
            -o StorySave.apk "$URL"
          # Verifiche minime
          test -f StorySave.apk
          file StorySave.apk
          SIZE=$(stat -c%s "StorySave.apk")
          if [ "$SIZE" -lt 1000000 ]; then
            echo "Download APK non valido (dimensione $SIZE)."
            exit 1
          fi

      - name: Build Docker image
        run: docker build -t apk-builder .

      - name: Run build script inside Docker
        run: docker run --rm -v ${{ github.workspace }}:/app apk-builder bash build.sh

      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: modded-apk
          path: aligned.apk
